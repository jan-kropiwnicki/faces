{% extends 'base.html' %}

{% block title %}{% if viewed_user == user %}My{% else %}{{ viewed_user.first_name }}'s{% endif %} profile &ndash; {% endblock %}

{% block content %}
    {% if user.is_authenticated %}

        <h2>{{ viewed_user.first_name }} {{ viewed_user.last_name }} @{{ viewed_user.username }}</h2>
        {% if viewed_user == user %}
            <a class="friend-button friend-button-active">You</a>
        {% elif user.person in viewed_user.person.friends.all %}
            <a class="friend-button friend-button-active" href="{% url 'end_friendship' viewed_user.username %}">End friendship</a>
        {% elif user.person in viewed_user.requestprofile.friend_requests.all %}
            <a class="friend-button friend-button-active">Pending friend request</a>
        {% else %}
            <a class="friend-button" href="{% url 'send_request' viewed_user.username %}">Send friend request</a>
        {% endif %}
        {% if post_list %}
            <p>{% if viewed_user == user %}Your{% else %}{{ viewed_user.first_name }}'s{% endif %} posts:</p>
        {% else %}
            <p>This user has no posts.</p>
        {% endif %}
        {% for post in post_list %}
            <div id="{{ post.0.id }}">
                <hr>
                <p>
                    Published on {{ post.0.date.date }} by <a href="{% url 'user' user.username %}">
                    {{ viewed_user.first_name }} {{ viewed_user.last_name }}</a> @{{ viewed_user.username }}
                    {% if viewed_user == user %}&nbsp;<a href="{% url 'edit_post' post.0.id %}" class="text-secondary"><i class="bi bi-pencil-square"></i></a>&nbsp;
                        <a class="text-secondary" data-bs-toggle="modal" data-bs-target="#deleteModal{{ post.0.id }}"><i class="bi bi-trash-fill"></i></a>
                        <div class="modal fade" tabindex="-1" role="dialog" id="deleteModal{{ post.0.id }}">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content rounded-3 shadow">
                                    <div class="modal-body p-4 text-center">
                                        <h5 class="mb-0">Are you sure?</h5>
                                        <p class="mb-0">If you delete the post, you'll not be able to bring it back</p>
                                    </div>
                                    <div class="modal-footer flex-nowrap p-0">
                                        <a class="btn btn-lg btn-link fs-6 text-decoration-none col-6 m-0 rounded-0 border-end" href="{% url 'delete_post' post.0.id %}"><strong>Yes, I'm sure</strong></a>
                                        <button type="button" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 m-0 rounded-0" data-bs-dismiss="modal">No, take me back</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </p>
                <p>
                {% for line in post.1 %}
                    {{ line }}<br>
                {% endfor %}
                </p>
                <p>
                    {% if user.likeprofile in post.0.likeprofile_set.all %}
                        <a class="like-icon" id="like-{{ post.0.id }}" onclick="dislike_{{ post.0.id }}()"><i class="bi bi-star-fill lead text-danger"></i></a>
                    {% else %}
                        <a class="like-icon" id="like-{{ post.0.id }}" onclick="like_{{ post.0.id }}()"><i class="bi bi-star lead text-danger"></i></a>
                    {% endif %}
                    <span id="like-count-{{ post.0.id }}">{{ post.2 }}</span>
                </p>
            </div>
            <script>
                function like_{{ post.0.id }}() {
                    $.ajax({
                        data: "id=" + {{ post.0.id }},
                        url: "{% url 'like' %}",
                        success: function (response) {
                            $("#like-" + {{ post.0.id }}).html('<i class="bi bi-star-fill lead text-danger"></i>');
                            $("#like-" + {{ post.0.id }}).attr("onclick", "dislike_{{ post.0.id }}()");
                            $("#like-count-" + {{ post.0.id }}).html(response.new_likes)
                        },
                        error: function (response) {
                            console.log(response.responseJSON.errors)
                        }
                    });
                }
                function dislike_{{ post.0.id }}() {
                    $.ajax({
                        data: "id=" + {{ post.0.id }},
                        url: "{% url 'dislike' %}",
                        success: function (response) {
                            $("#like-" + {{ post.0.id }}).html('<i class="bi bi-star lead text-danger"></i>');
                            $("#like-" + {{ post.0.id }}).attr("onclick", "like_{{ post.0.id }}()");
                            $("#like-count-" + {{ post.0.id }}).html(response.new_likes)
                        },
                        error: function (response) {
                            console.log(response.responseJSON.errors)
                        }
                    });
                }
            </script>
        {% endfor %}
    {% endif %}
{% endblock %}