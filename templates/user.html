{% extends 'base.html' %}

{% load static %}

{% block title %}{% if viewed_user == user %}My{% else %}{{ viewed_user.first_name }}'s{% endif %} profile &ndash; {% endblock %}

{% block content %}
    {% if user.is_authenticated %}

        <h2>
            <img src="{% static viewed_user.profilepicture.url %}" alt="{{ viewed_user.username }}" class="rounded-circle me-1" width="64" height="64">
            {{ viewed_user.first_name }} {{ viewed_user.last_name }} @{{ viewed_user.username }}
        {% if viewed_user == user %}
            <button class="btn btn-outline-primary my-3" disabled>You</button>
        {% elif user.person in viewed_user.person.friends.all %}
            <a class="btn btn-outline-primary my-3" href="{% url 'end_friendship' viewed_user.username %}">End friendship</a>
        {% elif user.person in viewed_user.requestprofile.friend_requests.all %}
            <button class="btn btn-outline-primary my-3" disabled>Pending friend request</button>
        {% else %}
            <a class="btn btn-primary my-3" href="{% url 'send_request' viewed_user.username %}"><strong>Send friend request</strong></a>
        {% endif %}
        {% if mutual_friend_count and viewed_user != user %}
            <span class="lead">Friend of {% for friend in mutual_friends %}
                {% if not forloop.counter %}
                    ,
                {% endif %}
                {{ friend.user.first_name }} {{ friend.user.last_name }} @{{ friend.user.username }}
            {% endfor %}
            {% if mutual_friend_count > 3 %}
                and {{ mutual_friend_count|add:'-3' }} more
            {% endif %}
            </span>
        {% endif %}
        </h2>
        {% if post_list %}
            <p>{% if viewed_user == user %}Your{% else %}{{ viewed_user.first_name }}'s{% endif %} posts:</p>
        {% else %}
            <p>This user has no posts.</p>
        {% endif %}
        {% for post in post_list %}
            <div id="{{ post.0.id }}">
                <hr>
                <p>
                    Published on {{ post.0.date.date }} by
                    <img src="{% static post.0.author.user.profilepicture.url %}" alt="{{ post.0.author.user.username }}" class="rounded-circle mx-1" width="32" height="32">
                    <a href="{% url 'user' viewed_user.username %}">
                    {{ viewed_user.first_name }} {{ viewed_user.last_name }}</a> @{{ viewed_user.username }}
                    {% if viewed_user == user %}&nbsp;<a href="{% url 'edit_post' post.0.id %}" class="lead text-secondary align-middle text-decoration-none">
                        <i class="bi bi-pencil-square"></i></a>&nbsp;
                        <a class="lead text-secondary align-middle text-decoration-none" data-bs-toggle="modal" data-bs-target="#deleteModal{{ post.0.id }}"
                           style="cursor: pointer"><i class="bi bi-trash-fill"></i></a>
                        <div class="modal fade" tabindex="-1" role="dialog" id="deleteModal{{ post.0.id }}">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content rounded-3 shadow">
                                    <div class="modal-body p-4 text-center">
                                        <h5 class="mb-0">Are you sure?</h5>
                                        <p class="mb-0">If you delete the post, you won't be able to bring it back</p>
                                    </div>
                                    <div class="modal-footer flex-nowrap p-0">
                                        <a class="btn btn-lg btn-link fs-6 text-decoration-none col-6 m-0 rounded-0 border-end" href="{% url 'delete_post' post.0.id %}"><strong>Yes, I'm sure</strong></a>
                                        <button type="button" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 m-0 rounded-0" data-bs-dismiss="modal">No, take me back</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </p>
                <p>
                {% for line in post.1 %}
                    {{ line }}<br>
                {% endfor %}
                </p>
                <p class="lead text-primary">
                    {% if user.likeprofile in post.0.likeprofile_set.all %}
                        <a id="like-{{ post.0.id }}" onclick="dislike_{{ post.0.id }}()"><i class="bi bi-star-fill"></i></a>
                    {% else %}
                        <a id="like-{{ post.0.id }}" onclick="like_{{ post.0.id }}()"><i class="bi bi-star"></i></a>
                    {% endif %}
                    <span id="like-count-{{ post.0.id }}">{{ post.2 }}</span><span class="mx-3"></span>
                    <a href="{% url 'post_page' post.0.id %}" class="text-primary text-decoration-none"><i class="bi bi-chat-square"></i>
                    {{ post.3 }}</a>
                </p>
            </div>
            <script>
                function like_{{ post.0.id }}() {
                    $.ajax({
                        data: "id=" + {{ post.0.id }},
                        url: "{% url 'like' %}",
                        success: function (response) {
                            $("#like-" + {{ post.0.id }}).html('<i class="bi bi-star-fill lead"></i>');
                            $("#like-" + {{ post.0.id }}).attr("onclick", "dislike_{{ post.0.id }}()");
                            $("#like-count-" + {{ post.0.id }}).html(response.new_likes)
                        },
                        error: function (response) {
                            console.log(response.responseJSON.errors)
                        }
                    });
                }
                function dislike_{{ post.0.id }}() {
                    $.ajax({
                        data: "id=" + {{ post.0.id }},
                        url: "{% url 'dislike' %}",
                        success: function (response) {
                            $("#like-" + {{ post.0.id }}).html('<i class="bi bi-star lead"></i>');
                            $("#like-" + {{ post.0.id }}).attr("onclick", "like_{{ post.0.id }}()");
                            $("#like-count-" + {{ post.0.id }}).html(response.new_likes)
                        },
                        error: function (response) {
                            console.log(response.responseJSON.errors)
                        }
                    });
                }
            </script>
        {% endfor %}
    {% endif %}
{% endblock %}